name: iOS 빌드 검증

# PR이나 특정 브랜치 push 시 빌드만 검증
on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'gear_freak_flutter/**'
      - '.github/workflows/ios-*.yml'

  push:
    branches:
      - develop
    paths:
      - 'gear_freak_flutter/**'

  # 수동 실행
  workflow_dispatch:

jobs:
  build_check:
    name: iOS 빌드 테스트
    runs-on: macos-latest

    steps:
      # 1. 코드 체크아웃
      - name: 저장소 체크아웃
        uses: actions/checkout@v4

      # 2. Flutter 설치
      - name: Flutter 설치
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.0'
          channel: 'stable'

      # 3. Flutter 의존성 설치
      - name: Flutter 의존성 설치
        working-directory: ./gear_freak_flutter
        run: flutter pub get

      # 4. .env 파일 생성
      - name: .env 파일 생성
        working-directory: ./gear_freak_flutter
        env:
          ENV_CONTENT: ${{ secrets.FLUTTER_ENV_FILE }}
        run: |
          echo "$ENV_CONTENT" > .env
          echo "✅ .env 파일 생성 완료"

      # 5. Flutter 분석 (린트 검사)
      - name: Flutter 분석
        working-directory: ./gear_freak_flutter
        run: flutter analyze

      # 6. Flutter 테스트 (테스트 파일이 있는 경우)
      # - name: Flutter 테스트
      #   working-directory: ./gear_freak_flutter
      #   run: flutter test

      # 7. Ruby 설치
      - name: Ruby 설치
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ./gear_freak_flutter/ios

      # 8. Fastlane 설치
      - name: Fastlane 설치
        working-directory: ./gear_freak_flutter/ios
        run: |
          gem install bundler
          bundle install

      # 9. iOS 빌드만 수행 (업로드 없음)
      - name: iOS 빌드 테스트
        working-directory: ./gear_freak_flutter/ios
        run: |
          # 빌드만 수행하고 에러 체크
          bundle exec fastlane build_only || echo "빌드 실패 - 에러 확인 필요"

      # 10. 빌드 결과 업로드
      - name: 빌드 로그 업로드
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-check-logs
          path: |
            ./gear_freak_flutter/ios/fastlane/report.xml
            ./gear_freak_flutter/ios/fastlane/*.log
          retention-days: 3

      # 11. 빌드 성공 알림
      - name: 빌드 성공
        if: success()
        run: echo "✅ iOS 빌드 검증 성공!"
