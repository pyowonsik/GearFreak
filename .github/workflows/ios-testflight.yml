name: iOS TestFlight ë°°í¬

# ì–¸ì œ ì‹¤í–‰í• ì§€ ì„¤ì •
on:
  # ìˆ˜ë™ ì‹¤í–‰ (GitHub Actions íƒ­ì—ì„œ ë²„íŠ¼ í´ë¦­)
  workflow_dispatch:

  # íŠ¹ì • ë¸Œëœì¹˜ì— pushí•  ë•Œ ìë™ ì‹¤í–‰ (ì„ íƒì‚¬í•­)
  # push:
  #   branches:
  #     - main
  #     - release/*

  # Tag ìƒì„± ì‹œ ìë™ ì‹¤í–‰ (ì˜ˆ: v1.0.0)
  # push:
  #   tags:
  #     - 'v*'

jobs:
  deploy_testflight:
    name: TestFlight ë°°í¬
    runs-on: macos-latest  # macOS í™˜ê²½ í•„ìˆ˜ (iOS ë¹Œë“œ)

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. Flutter ì„¤ì¹˜
      - name: Flutter ì„¤ì¹˜
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.0'
          channel: 'stable'

      # 3. Flutter ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Flutter ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: ./gear_freak_flutter
        run: flutter pub get

      # 3-1. CocoaPods ì„¤ì¹˜ ë° ì˜ì¡´ì„± í•´ê²°
      - name: CocoaPods ì„¤ì¹˜
        working-directory: ./gear_freak_flutter/ios
        run: |
          # CocoaPods ì˜ì¡´ì„± ì„¤ì¹˜
          pod install --repo-update
          echo "âœ… CocoaPods ì„¤ì¹˜ ì™„ë£Œ"

      # 4. .env íŒŒì¼ ìƒì„±
      - name: .env íŒŒì¼ ìƒì„±
        working-directory: ./gear_freak_flutter
        env:
          ENV_CONTENT: ${{ secrets.FLUTTER_ENV_FILE }}
        run: |
          echo "$ENV_CONTENT" > .env
          echo "âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ"

      # 5. Flutter ë¹Œë“œ ê²€ì¦ (ì„ íƒì‚¬í•­)
      - name: Flutter ë¶„ì„
        working-directory: ./gear_freak_flutter
        run: flutter analyze

      # 5-1. Flutter iOS ë¹Œë“œ (ì‚¬ì „ ë¹Œë“œ)
      - name: Flutter iOS ë¹Œë“œ
        working-directory: ./gear_freak_flutter
        run: |
          echo "ğŸ”¨ Flutter iOS ë¹Œë“œ ì‹œì‘..."

          # pubspec.yamlì—ì„œ ë²„ì „ ì¶”ì¶œ
          VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //')
          BUILD_NAME=$(echo $VERSION | cut -d'+' -f1)
          BUILD_NUMBER=$(echo $VERSION | cut -d'+' -f2)

          echo "ğŸ“¦ ë²„ì „ ì •ë³´: $BUILD_NAME+$BUILD_NUMBER"

          # ëª…ì‹œì ìœ¼ë¡œ ë²„ì „ ì „ë‹¬
          flutter build ios --release --no-codesign --build-name=$BUILD_NAME --build-number=$BUILD_NUMBER

          echo "âœ… Flutter iOS ë¹Œë“œ ì™„ë£Œ"

      # 6. Xcode ë²„ì „ í™•ì¸
      - name: Xcode ë²„ì „ í™•ì¸
        run: xcodebuild -version

      # 7. Ruby & Bundler ì„¤ì¹˜ (Fastlane ì‹¤í–‰ í™˜ê²½)
      - name: Ruby ì„¤ì¹˜
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ./gear_freak_flutter/ios

      # 8. Fastlane ì„¤ì¹˜
      - name: Fastlane ì„¤ì¹˜
        working-directory: ./gear_freak_flutter/ios
        run: |
          gem install bundler
          bundle install

      # 9. iOS ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜
      - name: iOS ì„œëª… ì„¤ì •
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ê²½ë¡œ
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Secrets ê²€ì¦
          if [ -z "$BUILD_CERTIFICATE_BASE64" ]; then
            echo "âŒ BUILD_CERTIFICATE_BASE64 secretì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
            exit 1
          fi
          if [ -z "$BUILD_PROVISION_PROFILE_BASE64" ]; then
            echo "âŒ BUILD_PROVISION_PROFILE_BASE64 secretì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
            exit 1
          fi
          if [ -z "$P12_PASSWORD" ]; then
            echo "âŒ P12_PASSWORD secretì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
            exit 1
          fi
          if [ -z "$KEYCHAIN_PASSWORD" ]; then
            echo "âŒ KEYCHAIN_PASSWORD secretì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
            exit 1
          fi
          echo "âœ… ëª¨ë“  Secrets ê²€ì¦ ì™„ë£Œ"

          # Secretsì—ì„œ Base64 ë””ì½”ë”©
          echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode > $CERTIFICATE_PATH
          echo "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode > $PP_PATH

          # íŒŒì¼ í¬ê¸° í™•ì¸
          echo "ğŸ“¦ ì¸ì¦ì„œ íŒŒì¼ í¬ê¸°: $(wc -c < $CERTIFICATE_PATH) bytes"
          echo "ğŸ“¦ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ í¬ê¸°: $(wc -c < $PP_PATH) bytes"

          if [ ! -s "$CERTIFICATE_PATH" ]; then
            echo "âŒ ì¸ì¦ì„œ íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. Base64 ì¸ì½”ë”©ì„ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi

          # Keychain ìƒì„±
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Keychainì„ ê²€ìƒ‰ ëª©ë¡ì— ì¶”ê°€ (import ì „ì— ì„¤ì •)
          security list-keychain -d user -s $KEYCHAIN_PATH

          # ì¸ì¦ì„œë¥¼ Keychainì— import
          echo "ğŸ” ì¸ì¦ì„œ import ì¤‘..."
          if ! security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH; then
            echo "âŒ ì¸ì¦ì„œ import ì‹¤íŒ¨. P12_PASSWORDë¥¼ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi
          echo "âœ… ì¸ì¦ì„œ import ì™„ë£Œ"

          # codesignì´ private keyì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ partition list ì„¤ì •
          # ì¼ë¶€ ì¸ì¦ì„œëŠ” private keyê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
          echo "ğŸ”‘ Partition list ì„¤ì • ì¤‘..."
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH 2>/dev/null || echo "âš ï¸ Partition list ì„¤ì • ìŠ¤í‚µ (private key ì—†ìŒ ê°€ëŠ¥)"

          # Keychainì„ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •
          security default-keychain -s $KEYCHAIN_PATH

          # ì¸ì¦ì„œ import í™•ì¸
          echo "=== ì„¤ì¹˜ëœ ì½”ë“œ ì„œëª… ì¸ì¦ì„œ ==="
          security find-identity -v -p codesigning $KEYCHAIN_PATH || true

          # ì‹œìŠ¤í…œ ì „ì²´ ì¸ì¦ì„œë„ í™•ì¸
          echo "=== ì „ì²´ ì½”ë“œ ì„œëª… ì¸ì¦ì„œ ==="
          security find-identity -v -p codesigning || true

          # í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜ (UUID ì¶”ì¶œ í›„ ì˜¬ë°”ë¥¸ íŒŒì¼ëª…ìœ¼ë¡œ ì €ì¥)
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          PP_UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" /dev/stdin <<< $(security cms -D -i $PP_PATH))
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$PP_UUID.mobileprovision

          echo "âœ… iOS ì„œëª… ì„¤ì • ì™„ë£Œ"
          echo "âœ… í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜ ì™„ë£Œ (UUID: $PP_UUID)"

      # 9-1. í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ í™•ì¸
      - name: í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ í™•ì¸
        run: |
          echo "=== ì„¤ì¹˜ëœ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ==="
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

          echo ""
          echo "=== í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ìƒì„¸ ì •ë³´ ==="
          for profile in ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision; do
            echo "Profile: $profile"
            security cms -D -i "$profile" | plutil -p - | grep -E "Name|UUID|application-identifier|aps-environment|applesignin" || true
            echo "---"
          done

      # 10. App Store Connect API Key ì„¤ì •
      - name: App Store Connect API Key ìƒì„±
        working-directory: ./gear_freak_flutter/ios/fastlane
        env:
          API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          # ì‹œí¬ë¦¿ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if [ -z "$API_KEY_CONTENT" ]; then
            echo "âŒ ì—ëŸ¬: APP_STORE_CONNECT_API_KEY_CONTENT ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          fi

          echo "ğŸ” GitHub Secrets ë°ì´í„° í˜•ì‹ í™•ì¸ ì¤‘..."

          # ì‹œë‚˜ë¦¬ì˜¤ 1: Base64 ì¸ì½”ë”©ëœ ë¬¸ìì—´ (ì˜¬ë°”ë¥¸ ê²½ìš°)
          # ì‹œë‚˜ë¦¬ì˜¤ 2: ì´ë¯¸ ë””ì½”ë”©ëœ í…ìŠ¤íŠ¸ (PEM í˜•ì‹)

          # Secrets ë°ì´í„°ë¥¼ ì„ì‹œ íŒŒì¼ì— ì €ì¥
          echo "$API_KEY_CONTENT" > temp_secret.txt

          # PEM í˜•ì‹ì¸ì§€ í™•ì¸ (ì´ë¯¸ ë””ì½”ë”©ëœ ìƒíƒœ)
          if head -n 1 temp_secret.txt | grep -q "BEGIN PRIVATE KEY"; then
            echo "âœ… Secretsì— PEM í˜•ì‹ í…ìŠ¤íŠ¸ê°€ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤ (base64 ë””ì½”ë”© ë¶ˆí•„ìš”)"
            mv temp_secret.txt AuthKey.p8
          else
            echo "ğŸ”„ Base64 ë””ì½”ë”© ì‹œë„ ì¤‘..."
            # Base64 ë””ì½”ë”© ì‹œë„
            cat temp_secret.txt | tr -d '\n\r ' | base64 --decode > AuthKey.p8 2>/dev/null

            if [ $? -ne 0 ]; then
              echo "âŒ Base64 ë””ì½”ë”© ì‹¤íŒ¨"
              echo "GitHub Secrets ë°ì´í„° ì• 100ì:"
              head -c 100 temp_secret.txt
              rm -f temp_secret.txt
              exit 1
            fi
            rm -f temp_secret.txt
          fi

          # íŒŒì¼ í¬ê¸° í™•ì¸
          if [ ! -s AuthKey.p8 ]; then
            echo "âŒ ì—ëŸ¬: AuthKey.p8 íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
            exit 1
          fi

          # PEM í˜•ì‹ ê²€ì¦
          if head -n 1 AuthKey.p8 | grep -q "BEGIN PRIVATE KEY"; then
            echo "âœ… íŒŒì¼ í¬ë§· ê²€ì¦ í†µê³¼ (PEM í˜•ì‹)"
          else
            echo "âŒ ì—ëŸ¬: íŒŒì¼ì´ ì˜¬ë°”ë¥¸ PEM í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤"
            echo "íŒŒì¼ ë‚´ìš© ì• 5ì¤„:"
            head -n 5 AuthKey.p8
            echo ""
            echo "16ì§„ìˆ˜ ë¤í”„ (ì• 100ë°”ì´íŠ¸):"
            head -c 100 AuthKey.p8 | od -x
            echo ""
            echo "ğŸ“‹ í•´ê²° ë°©ë²•:"
            echo "1. ì›ë³¸ AuthKey.p8 íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš” (PEM í˜•ì‹ì´ì–´ì•¼ í•¨)"
            echo "2. ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì˜¬ë°”ë¥´ê²Œ base64 ì¸ì½”ë”©í•˜ì„¸ìš”:"
            echo "   cat AuthKey.p8 | base64 | tr -d '\\n'"
            echo "3. GitHub Secretsì˜ APP_STORE_CONNECT_API_KEY_CONTENTë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”"
            exit 1
          fi

          # ê¶Œí•œ ì„¤ì •
          chmod 600 AuthKey.p8

          # íŒŒì¼ ì •ë³´ ì¶œë ¥
          echo "âœ… AuthKey.p8 íŒŒì¼ ìƒì„± ì™„ë£Œ"
          ls -lh AuthKey.p8
          echo "íŒŒì¼ ì²« ì¤„: $(head -n 1 AuthKey.p8)"

      # (ì„ íƒì‚¬í•­) Matchë¥¼ ì‚¬ìš©í•œ ì¸ì¦ì„œ ê´€ë¦¬
      # Matchë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ê³  ìœ„ì˜ ìˆ˜ë™ ì¸ì¦ì„œ ì„¤ì¹˜ ë‹¨ê³„ë¥¼ ì œê±°í•˜ì„¸ìš”
      # - name: iOS ì¸ì¦ì„œ ì„¤ì • (Match)
      #   working-directory: ./gear_freak_flutter/ios
      #   env:
      #     MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      #   run: bundle exec fastlane match appstore --readonly

      # 11. TestFlight ë°°í¬ ì‹¤í–‰
      - name: Fastlane Beta ì‹¤í–‰
        working-directory: ./gear_freak_flutter/ios
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: bundle exec fastlane beta

      # 11-1. Keychain ì •ë¦¬
      - name: Keychain ì •ë¦¬
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
          echo "âœ… Keychain ì •ë¦¬ ì™„ë£Œ"

      # 12. ë¹Œë“œ ì‚°ì¶œë¬¼ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹…ìš©)
      - name: ë¹Œë“œ ë¡œê·¸ ì—…ë¡œë“œ
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            ./gear_freak_flutter/ios/fastlane/report.xml
            ./gear_freak_flutter/ios/fastlane/*.log
            ~/Library/Logs/gym/*.log
          retention-days: 7

      # 12-1. xcodebuild ë¡œê·¸ ì¶œë ¥ (ì‹¤íŒ¨ ì‹œ)
      - name: xcodebuild ë¡œê·¸ ì¶œë ¥
        if: failure()
        run: |
          echo "=== xcodebuild ì „ì²´ ë¡œê·¸ (ë§ˆì§€ë§‰ 500ì¤„) ==="
          if [ -f ~/Library/Logs/gym/Runner-Runner.log ]; then
            tail -n 500 ~/Library/Logs/gym/Runner-Runner.log
          else
            echo "ë¡œê·¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            ls -la ~/Library/Logs/gym/ 2>/dev/null || echo "gym ë¡œê·¸ ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi

      # 13. ì„±ê³µ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          echo "âœ… TestFlight ë°°í¬ ì™„ë£Œ!"
          echo "App Store Connectì—ì„œ í™•ì¸í•˜ì„¸ìš”: https://appstoreconnect.apple.com"
