name: iOS 환경 설정 검증

# 수동 실행만 가능
on:
  workflow_dispatch:

jobs:
  env_check:
    name: 환경 설정 체크
    runs-on: macos-latest

    steps:
      # 1. 코드 체크아웃
      - name: 저장소 체크아웃
        uses: actions/checkout@v4

      # 2. 시스템 정보 확인
      - name: macOS 버전 확인
        run: |
          echo "=== macOS 정보 ==="
          sw_vers
          echo ""
          echo "=== Xcode 버전 ==="
          xcodebuild -version
          echo ""
          echo "=== Ruby 버전 ==="
          ruby --version

      # 3. Flutter 설치
      - name: Flutter 설치
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      # 4. Flutter 버전 확인
      - name: Flutter 정보 확인
        run: |
          echo "=== Flutter 버전 ==="
          flutter --version
          echo ""
          echo "=== Flutter Doctor ==="
          flutter doctor -v

      # 5. Flutter 의존성 설치
      - name: Flutter 의존성 설치
        working-directory: ./gear_freak_flutter
        run: |
          echo "=== Flutter pub get 실행 ==="
          flutter pub get
          echo "✅ Flutter 의존성 설치 완료"

      # 6. .env 파일 생성 테스트
      - name: .env 파일 생성 및 검증
        working-directory: ./gear_freak_flutter
        env:
          ENV_CONTENT: ${{ secrets.FLUTTER_ENV_FILE }}
        run: |
          echo "=== .env 파일 생성 ==="

          # Secret이 설정되었는지 확인
          if [ -z "$ENV_CONTENT" ]; then
            echo "❌ FLUTTER_ENV_FILE Secret이 설정되지 않았습니다!"
            exit 1
          fi

          # .env 파일 생성
          echo "$ENV_CONTENT" > .env

          # 파일 생성 확인
          if [ ! -f .env ]; then
            echo "❌ .env 파일 생성 실패!"
            exit 1
          fi

          echo "✅ .env 파일 생성 완료"
          echo ""
          echo "=== .env 파일 내용 확인 (값은 숨김) ==="
          # 키만 출력 (값은 보안상 숨김)
          grep -o '^[^=]*' .env | while read key; do
            echo "  ✓ $key"
          done

          echo ""
          echo "=== .env 파일 라인 수 ==="
          wc -l < .env

          # 필수 환경변수 체크
          echo ""
          echo "=== 필수 환경변수 체크 ==="
          required_vars=("BASE_URL" "S3_PUBLIC_BASE_URL" "KAKAO_NATIVE_APP_KEY" "NAVER_CLIENT_ID")
          for var in "${required_vars[@]}"; do
            if grep -q "^$var=" .env; then
              echo "  ✅ $var 존재"
            else
              echo "  ❌ $var 없음"
            fi
          done

      # 7. Ruby 설치
      - name: Ruby & Bundler 설치
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ./gear_freak_flutter/ios

      # 8. Fastlane 설치
      - name: Fastlane 설치 확인
        working-directory: ./gear_freak_flutter/ios
        run: |
          echo "=== Bundler 버전 ==="
          bundle --version

          echo ""
          echo "=== Fastlane 설치 ==="
          gem install bundler
          bundle install

          echo ""
          echo "=== Fastlane 버전 ==="
          bundle exec fastlane --version

      # 9. Fastlane 파일 확인
      - name: Fastlane 설정 파일 확인
        working-directory: ./gear_freak_flutter/ios/fastlane
        run: |
          echo "=== Fastlane 디렉토리 파일 목록 ==="
          ls -la

          echo ""
          echo "=== Appfile 존재 확인 ==="
          if [ -f Appfile ]; then
            echo "✅ Appfile 존재"
            echo "--- Appfile 내용 ---"
            cat Appfile
          else
            echo "❌ Appfile 없음"
          fi

          echo ""
          echo "=== Fastfile 존재 확인 ==="
          if [ -f Fastfile ]; then
            echo "✅ Fastfile 존재"
            echo "--- Fastfile Lane 목록 ---"
            grep "lane :" Fastfile
          else
            echo "❌ Fastfile 없음"
          fi

      # 10. App Store Connect API Key 검증
      - name: App Store Connect API Key 검증
        working-directory: ./gear_freak_flutter/ios/fastlane
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          echo "=== App Store Connect API Secrets 확인 ==="

          # API_KEY_ID 확인
          if [ -z "$API_KEY_ID" ]; then
            echo "❌ APP_STORE_CONNECT_API_KEY_ID Secret 없음"
          else
            echo "✅ APP_STORE_CONNECT_API_KEY_ID 존재: ${API_KEY_ID}"
          fi

          # ISSUER_ID 확인
          if [ -z "$ISSUER_ID" ]; then
            echo "❌ APP_STORE_CONNECT_ISSUER_ID Secret 없음"
          else
            echo "✅ APP_STORE_CONNECT_ISSUER_ID 존재: ${ISSUER_ID}"
          fi

          # API_KEY_CONTENT 확인
          if [ -z "$API_KEY_CONTENT" ]; then
            echo "❌ APP_STORE_CONNECT_API_KEY_CONTENT Secret 없음"
            exit 1
          else
            echo "✅ APP_STORE_CONNECT_API_KEY_CONTENT 존재"
          fi

          echo ""
          echo "=== AuthKey.p8 파일 생성 테스트 ==="
          echo "$API_KEY_CONTENT" > AuthKey.p8
          chmod 600 AuthKey.p8

          # 파일 생성 확인
          if [ ! -f AuthKey.p8 ]; then
            echo "❌ AuthKey.p8 생성 실패"
            exit 1
          fi

          echo "✅ AuthKey.p8 생성 완료"

          # 파일 내용 검증 (BEGIN/END 확인)
          if grep -q "BEGIN PRIVATE KEY" AuthKey.p8 && grep -q "END PRIVATE KEY" AuthKey.p8; then
            echo "✅ AuthKey.p8 형식 올바름"
          else
            echo "❌ AuthKey.p8 형식 오류 (BEGIN/END PRIVATE KEY 없음)"
            exit 1
          fi

          # 파일 크기 확인
          file_size=$(wc -c < AuthKey.p8)
          echo "AuthKey.p8 파일 크기: ${file_size} bytes"

          # 권한 확인
          ls -la AuthKey.p8

      # 11. Fastlane 명령어 테스트
      - name: Fastlane 명령어 실행 테스트
        working-directory: ./gear_freak_flutter/ios
        run: |
          echo "=== Fastlane Lanes 목록 ==="
          bundle exec fastlane lanes

          echo ""
          echo "=== 빌드 번호 확인 ==="
          current_build=$(bundle exec fastlane run get_build_number xcodeproj:"Runner.xcodeproj")
          echo "현재 빌드 번호: ${current_build}"

      # 12. Xcode 프로젝트 확인
      - name: Xcode 프로젝트 설정 확인
        working-directory: ./gear_freak_flutter/ios
        run: |
          echo "=== Xcode 프로젝트 파일 확인 ==="
          ls -la | grep -E "\.xcodeproj|\.xcworkspace"

          echo ""
          echo "=== Bundle Identifier 확인 ==="
          # Info.plist에서 Bundle ID 확인
          if [ -f Runner/Info.plist ]; then
            /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" Runner/Info.plist || echo "Bundle ID 확인 실패"
          fi

      # 13. 최종 요약
      - name: 환경 설정 검증 완료
        run: |
          echo ""
          echo "=================================="
          echo "✅ iOS CI/CD 환경 설정 검증 완료!"
          echo "=================================="
          echo ""
          echo "검증 완료 항목:"
          echo "  ✅ macOS & Xcode 환경"
          echo "  ✅ Flutter 설치 및 의존성"
          echo "  ✅ .env 파일 생성 및 환경변수"
          echo "  ✅ Ruby & Fastlane 설치"
          echo "  ✅ Fastlane 설정 파일 (Appfile, Fastfile)"
          echo "  ✅ App Store Connect API Key"
          echo "  ✅ AuthKey.p8 생성 및 형식"
          echo "  ✅ Fastlane 명령어 실행"
          echo "  ✅ Xcode 프로젝트 설정"
          echo ""
          echo "🚀 다음 단계: ios-build-check.yml 또는 ios-testflight.yml 실행"

      # 14. 실패 시 로그 업로드
      - name: 검증 실패 시 로그 업로드
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: env-check-logs
          path: |
            ./gear_freak_flutter/ios/fastlane/*.log
            ./gear_freak_flutter/ios/fastlane/report.xml
          retention-days: 3
