# Fastfile
# iOS ë°°í¬ ìë™í™” ìŠ¤í¬ë¦½íŠ¸

# ì‚¬ìš© í†µê³„ ì „ì†¡ ë¹„í™œì„±í™” (ì„ íƒì‚¬í•­)
opt_out_usage

# ê¸°ë³¸ í”Œë«í¼
default_platform(:ios)

platform :ios do

  # ==================== App Store Connect API ì¸ì¦ ====================

  before_all do
    # App Store Connect API í‚¤ ì„¤ì •
    # í™˜ê²½ë³€ìˆ˜ì—ì„œ ì½ì–´ì˜¤ê±°ë‚˜ í•˜ë“œì½”ë”©ëœ ê°’ ì‚¬ìš©
    api_key_id = ENV["APP_STORE_CONNECT_API_KEY_ID"] || "Y28LL7R646"
    api_issuer_id = ENV["APP_STORE_CONNECT_ISSUER_ID"] || "fe34bf88-2267-4565-a7df-0208753cb935"

    # AuthKey.p8 íŒŒì¼ ê²½ë¡œ (Fastfileê³¼ ê°™ì€ ë””ë ‰í† ë¦¬, ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜)
    key_filepath = File.expand_path("AuthKey.p8", __dir__)

    # íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    unless File.exist?(key_filepath)
      UI.user_error!("âŒ AuthKey.p8 íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: #{key_filepath}")
    end

    # íŒŒì¼ í¬ê¸° í™•ì¸ (ë¹„ì–´ìˆëŠ” íŒŒì¼ ì²´í¬)
    if File.size(key_filepath) == 0
      UI.user_error!("âŒ AuthKey.p8 íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤")
    end

    # íŒŒì¼ í˜•ì‹ ê²€ì¦ (PEM í˜•ì‹ í™•ì¸)
    file_content = File.read(key_filepath)
    unless file_content.start_with?("-----BEGIN PRIVATE KEY-----")
      UI.error("âŒ AuthKey.p8 íŒŒì¼ì´ ì˜¬ë°”ë¥¸ PEM í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤")
      UI.error("íŒŒì¼ ì²« ì¤„: #{file_content.lines.first}")
      UI.user_error!("GitHub Secretsì˜ APP_STORE_CONNECT_API_KEY_CONTENTë¥¼ í™•ì¸í•˜ì„¸ìš”")
    end

    UI.message("âœ… AuthKey.p8 íŒŒì¼ ê²€ì¦ ì™„ë£Œ (í¬ê¸°: #{File.size(key_filepath)} bytes)")

    app_store_connect_api_key(
      key_id: api_key_id,
      issuer_id: api_issuer_id,
      key_filepath: key_filepath,
      duration: 1200, # 20ë¶„ (ì„ íƒì‚¬í•­)
      in_house: false # App Store ë°°í¬ (Enterpriseê°€ ì•„ë‹˜)
    )
  end

  # ==================== TestFlight ë² íƒ€ ë°°í¬ ====================

  desc "TestFlightì— ë² íƒ€ ë²„ì „ ë°°í¬"
  desc "ì‚¬ìš©ë²•: fastlane beta"
  lane :beta do
    # 1. App Store Connectì—ì„œ ìµœì‹  ë¹Œë“œ ë²ˆí˜¸ ê°€ì ¸ì™€ì„œ +1
    latest_build_number = latest_testflight_build_number(
      app_identifier: "com.pyowonsik.gearFreakFlutter"
    )
    increment_build_number(
      xcodeproj: "Runner.xcodeproj",
      build_number: latest_build_number + 1
    )
    UI.message("ğŸ“¦ ë¹Œë“œ ë²ˆí˜¸: #{latest_build_number} â†’ #{latest_build_number + 1}")

    # 2. ì½”ë“œ ì„œëª… ì„¤ì • (CI í™˜ê²½ìš© ìˆ˜ë™ ì„œëª…)
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Runner.xcodeproj",
      team_id: "J26F9UUXYM",
      bundle_identifier: "com.pyowonsik.gearFreakFlutter",
      profile_name: "GearFreak Production",
      code_sign_identity: "Apple Distribution"
    )

    # 3. iOS ì•± ë¹Œë“œ
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      clean: true,
      export_method: "app-store",
      xcargs: "-allowProvisioningUpdates",
      export_options: {
        method: "app-store",
        signingStyle: "manual",
        teamID: "J26F9UUXYM",
        provisioningProfiles: {
          "com.pyowonsik.gearFreakFlutter" => "GearFreak Production"
        }
      }
    )

    # 4. TestFlightì— ì—…ë¡œë“œ
    upload_to_testflight(
      skip_waiting_for_build_processing: true  # ë¹Œë“œ ì²˜ë¦¬ ëŒ€ê¸° ê±´ë„ˆë›°ê¸°
    )

    # 5. ì„±ê³µ ë©”ì‹œì§€
    UI.success("âœ… TestFlight ì—…ë¡œë“œ ì™„ë£Œ!")
    UI.success("App Store Connectì—ì„œ í™•ì¸í•˜ì„¸ìš”: https://appstoreconnect.apple.com")
  end

  # ==================== App Store ì •ì‹ ë°°í¬ ====================

  desc "App Storeì— ì •ì‹ ë²„ì „ ì—…ë¡œë“œ (ì‹¬ì‚¬ ì œì¶œì€ ìˆ˜ë™)"
  desc "ì‚¬ìš©ë²•: fastlane release"
  lane :release do
    # 1. App Store Connectì—ì„œ ìµœì‹  ë¹Œë“œ ë²ˆí˜¸ ê°€ì ¸ì™€ì„œ +1
    latest_build_number = app_store_build_number(
      app_identifier: "com.pyowonsik.gearFreakFlutter",
      live: false
    )
    increment_build_number(
      xcodeproj: "Runner.xcodeproj",
      build_number: latest_build_number + 1
    )
    UI.message("ğŸ“¦ ë¹Œë“œ ë²ˆí˜¸: #{latest_build_number} â†’ #{latest_build_number + 1}")

    # 2. ì½”ë“œ ì„œëª… ì„¤ì • (CI í™˜ê²½ìš© ìˆ˜ë™ ì„œëª…)
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Runner.xcodeproj",
      team_id: "J26F9UUXYM",
      bundle_identifier: "com.pyowonsik.gearFreakFlutter",
      profile_name: "GearFreak Production",
      code_sign_identity: "Apple Distribution"
    )

    # 3. iOS ì•± ë¹Œë“œ
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      clean: true,
      export_method: "app-store",
      xcargs: "-allowProvisioningUpdates",
      export_options: {
        method: "app-store",
        signingStyle: "manual",
        teamID: "J26F9UUXYM",
        provisioningProfiles: {
          "com.pyowonsik.gearFreakFlutter" => "GearFreak Production"
        }
      }
    )

    # 4. App Store Connectì— ì—…ë¡œë“œ (ì‹¬ì‚¬ ì œì¶œ X)
    upload_to_app_store(
      submit_for_review: false,      # ìë™ ì‹¬ì‚¬ ì œì¶œ ì•ˆ í•¨
      automatic_release: false,      # ì‹¬ì‚¬ í†µê³¼ í›„ ìë™ ë°°í¬ ì•ˆ í•¨
      skip_metadata: true,           # ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ê±´ë„ˆë›°ê¸°
      skip_screenshots: true         # ìŠ¤í¬ë¦°ìƒ· ì—…ë°ì´íŠ¸ ê±´ë„ˆë›°ê¸°
    )

    UI.success("âœ… App Store Connect ì—…ë¡œë“œ ì™„ë£Œ!")
    UI.message("App Store Connectì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¬ì‚¬ë¥¼ ì œì¶œí•˜ì„¸ìš”")
  end

  # ==================== ë¹Œë“œë§Œ ìˆ˜í–‰ ====================

  desc "iOS ì•± ë¹Œë“œë§Œ ìˆ˜í–‰ (ì—…ë¡œë“œ ì—†ìŒ)"
  desc "ì‚¬ìš©ë²•: fastlane build_only"
  lane :build_only do
    # 1. ì½”ë“œ ì„œëª… ì„¤ì • (CI í™˜ê²½ìš© ìˆ˜ë™ ì„œëª…)
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Runner.xcodeproj",
      team_id: "J26F9UUXYM",
      bundle_identifier: "com.pyowonsik.gearFreakFlutter",
      profile_name: "GearFreak Production",
      code_sign_identity: "Apple Distribution"
    )

    # 2. iOS ì•± ë¹Œë“œ
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      clean: true,
      export_method: "app-store",
      xcargs: "-allowProvisioningUpdates",
      export_options: {
        method: "app-store",
        signingStyle: "manual",
        teamID: "J26F9UUXYM",
        provisioningProfiles: {
          "com.pyowonsik.gearFreakFlutter" => "GearFreak Production"
        }
      }
    )

    UI.success("âœ… ë¹Œë“œ ì™„ë£Œ!")
    UI.message("ë¹Œë“œ íŒŒì¼ ìœ„ì¹˜: #{lane_context[SharedValues::IPA_OUTPUT_PATH]}")
  end

  # ==================== ë¹Œë“œ ë²ˆí˜¸ë§Œ ì¦ê°€ ====================

  desc "ë¹Œë“œ ë²ˆí˜¸ë§Œ 1 ì¦ê°€"
  desc "ì‚¬ìš©ë²•: fastlane bump_build"
  lane :bump_build do
    increment_build_number(xcodeproj: "Runner.xcodeproj")

    current_build = get_build_number(xcodeproj: "Runner.xcodeproj")
    UI.success("ë¹Œë“œ ë²ˆí˜¸ê°€ #{current_build}(ìœ¼)ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤")
  end

end
