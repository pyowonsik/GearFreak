# 작업 목록 (TODO)

## 1. flutter_chat_ui → 커스텀 채팅 UI로 변경

### 이유

- **날짜/시간 표시 커스터마이징 불가**: `flutter_chat_ui`의 날짜/시간 표시를 커스터마이징할 수 없음
- **무한 스크롤 처리 불안정**: `flutter_chat_ui`의 무한 스크롤이 불안정함
- **기존 앱의 무한 스크롤 패턴 적용 필요**: 기존 앱에서 사용 중인 무한 스크롤 패턴을 채팅에도 적용

### 구현 사항

- [ ] 커스텀 채팅 UI 컴포넌트 구현
  - [ ] 메시지 버블 위젯
  - [ ] 메시지 입력창 위젯
  - [ ] 날짜/시간 표시 커스터마이징
  - [ ] 상품 정보 카드 (기존 유지)
- [ ] 무한 스크롤 구현
  - [ ] 위로 스크롤 시 이전 메시지 로드
  - [ ] 디바운스 처리
  - [ ] 로딩 인디케이터
- [ ] 실시간 메시지 수신 처리 (기존 스트림 유지)

### pagination_scroll_mixin 사용 가능 여부

**현재 상황:**

- `pagination_scroll_mixin.dart`는 **하단 스크롤 감지 방식** (일반 리스트용)
- 채팅은 **위로 스크롤 시 이전 메시지 로드** 필요
- 채팅은 `reverse: true` 또는 최신 메시지가 하단에 있는 구조

**결론:**

- `pagination_scroll_mixin`을 **그대로 사용하기는 어려움**
- 하지만 **로직을 참고하여 채팅용으로 수정**하거나, **채팅 전용 mixin 생성** 가능
- 현재 `chat_loaded_view.dart`에서 사용 중인 `NotificationListener<ScrollNotification>` 방식과 유사한 로직이므로, 이를 기반으로 커스텀 UI에 적용

**제안:**

1. `pagination_scroll_mixin`의 디바운스 로직과 상태 관리 방식을 참고
2. 채팅 전용 `ChatPaginationScrollMixin` 생성 (위로 스크롤 감지)
3. 또는 기존 mixin을 확장하여 `reverse` 옵션 추가

---

## 2. 판매 완료 상태 변경 시 후기 작성 기능

### 요구사항

- 판매 완료 상태 변경 시 해당 상품의 채팅 상대 모두 조회
- 거래 완료한 사용자에게 후기 + 별점 작성 요청
- 후기 작성 및 관리 기능 필요

### 구현 사항

#### 서버 측

- [ ] 후기 모델 설계
  - [ ] 별점 (1~5점)
  - [ ] 후기 내용
  - [ ] 작성자 ID
  - [ ] 대상자 ID (후기를 받는 사람)
  - [ ] 상품 ID
  - [ ] 작성일시
- [ ] 후기 작성 API
  - [ ] 후기 생성
  - [ ] 후기 수정
  - [ ] 후기 삭제
- [ ] 후기 조회 API
  - [ ] 사용자별 후기 목록 조회
  - [ ] 상품별 후기 목록 조회
  - [ ] 후기 상세 조회
- [ ] 판매 완료 시 후기 작성 대상자 조회 API
  - [ ] 해당 상품의 채팅 상대 모두 조회
  - [ ] 거래 완료한 사용자 필터링

#### 클라이언트 측

- [ ] 후기 작성 화면
  - [ ] 별점 선택 UI (1~5점)
  - [ ] 후기 내용 입력
  - [ ] 후기 작성 완료
- [ ] 후기 목록 화면
  - [ ] 내가 작성한 후기
  - [ ] 내가 받은 후기
- [ ] 후기 관리 기능
  - [ ] 후기 수정
  - [ ] 후기 삭제
- [ ] 판매 완료 시 후기 작성 플로우
  - [ ] 판매 완료 상태 변경 시 후기 작성 대상자 조회
  - [ ] 후기 작성 안내/요청 UI
  - [ ] 후기 작성 화면으로 이동

---

## 3. 채팅 알림 기능 구현

### 현재 상태

- ✅ 실시간 메시지 전송은 동작 (Redis + Server Events)
- ❌ 알림 기능 미적용

### 결정 사항

- **FCM 직접 호출 방식 선택**
- SNS/SQS 아키텍처는 제외
- 이유: 소규모 앱이므로 과도한 메시지 사용이 되지 않음, AWS 추가 과금 불필요

### 구현 사항

#### 서버 측

- [ ] FCM 토큰 관리
  - [ ] 사용자별 FCM 토큰 저장/업데이트 API
  - [ ] FCM 토큰 삭제 API (로그아웃 시)
- [ ] FCM 전송 로직
  - [ ] 메시지 전송 시 수신자에게 FCM 알림 발송
  - [ ] 현재 채팅방에 있는 사용자는 알림 생략
  - [ ] 재시도 로직 (간단한 exponential backoff)
- [ ] FCM 서버 키 관리
  - [ ] 환경 변수로 관리
  - [ ] 보안 처리

#### 클라이언트 측

- [ ] FCM 초기화
  - [ ] `firebase_messaging` 패키지 추가
  - [ ] FCM 토큰 획득
  - [ ] 서버에 FCM 토큰 등록
- [ ] 알림 수신 처리
  - [ ] 포그라운드 알림 처리
  - [ ] 백그라운드 알림 처리
  - [ ] 알림 클릭 시 채팅방으로 이동
- [ ] 알림 권한 요청
  - [ ] iOS: 알림 권한 요청
  - [ ] Android: 알림 권한 요청 (Android 13+)

### FCM 직접 호출 vs SNS/SQS

**FCM 직접 호출 선택 이유:**

- 소규모 앱 (동시 사용자 수천 명 수준)
- 초당 메시지 수십~수백 건 수준
- FCM rate limit 여유 있음
- AWS 추가 비용 불필요
- 구현 단순

**SNS/SQS 전환 시점:**

- 초당 메시지 500건 이상
- FCM 실패율 5% 이상
- FCM rate limit에 자주 도달
- 서버 응답 시간 저하

---

## 우선순위

1. **1순위**: 커스텀 채팅 UI 변경 (사용자 경험 개선)
2. **2순위**: 채팅 알림 기능 구현 (핵심 기능)
3. **3순위**: 후기 작성 기능 (추가 기능)

---

## 참고 사항

### pagination_scroll_mixin 분석

- **위치**: `gear_freak_flutter/lib/common/utils/pagination_scroll_mixin.dart`
- **용도**: 일반 리스트의 하단 스크롤 감지
- **채팅 적용**: 직접 사용 어려움, 로직 참고하여 채팅용으로 수정 필요

### 현재 채팅 무한 스크롤 구현

- **위치**: `gear_freak_flutter/lib/feature/chat/presentation/view/chat_loaded_view.dart`
- **방식**: `NotificationListener<ScrollNotification>` 사용
- **로직**: 위로 스크롤 시 상단 300px 이내 도달하면 이전 메시지 로드
- **디바운스**: 300ms
