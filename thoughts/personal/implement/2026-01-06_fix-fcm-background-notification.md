# 2026-01-06 | FCM Background Notification Tap Issue Fix

## ì‘ì—… ë‚´ìš©
ë°±ê·¸ë¼ìš´ë“œâ†’í¬ê·¸ë¼ìš´ë“œ ì „í™˜ ì‹œ FCM ì•Œë¦¼ íƒ­ìœ¼ë¡œ ì±„íŒ…ë°© ì´ë™ì´ ì•ˆ ë˜ëŠ” ë¬¸ì œ í•´ê²°

## íŒŒì¼
- `lib/main.dart`
- `lib/shared/service/fcm_service.dart`

## ë¬¸ì œ

### ì¦ìƒ
ì•±ì´ ë°±ê·¸ë¼ìš´ë“œì— ìˆì„ ë•Œ ì±„íŒ… ì•Œë¦¼ì„ íƒ­í•˜ë©´:
- âœ… ì•±ì´ í¬ê·¸ë¼ìš´ë“œë¡œ ì „í™˜ë¨
- âŒ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ë©ˆì¶¤

### ê·¼ë³¸ ì›ì¸
`FirebaseMessaging.onMessageOpenedApp` ë¦¬ìŠ¤ë„ˆê°€ `FCMService.initialize()` ì•ˆì— ìœ„ì¹˜:
- `initialize()`ëŠ” **ë¡œê·¸ì¸ í›„**ì— í˜¸ì¶œë¨
- ë°±ê·¸ë¼ìš´ë“œâ†’í¬ê·¸ë¼ìš´ë“œ ì•Œë¦¼ íƒ­ì€ **ë¡œê·¸ì¸ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´** ë°œìƒ
- ë”°ë¼ì„œ ë¡œê·¸ì¸ ì „ ë˜ëŠ” ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì „ì— ì•Œë¦¼ íƒ­ ì‹œ ì´ë²¤íŠ¸ë¥¼ ë†“ì¹¨

### ì½”ë“œ ë¶„ì„

**Before** (`fcm_service.dart`):
```dart
Future<void> initialize({GoRouter? router}) async {
  // ë¡œê·¸ì¸ í›„ì— í˜¸ì¶œë¨

  // ë°±ê·¸ë¼ìš´ë“œâ†’í¬ê·¸ë¼ìš´ë“œ ë¦¬ìŠ¤ë„ˆ (ë¡œê·¸ì¸ í›„ì—ë§Œ ë“±ë¡ë¨!)
  FirebaseMessaging.onMessageOpenedApp.listen((message) {
    handleNotificationTap(message);
  });
}
```

**ë¬¸ì œì **:
1. ë¡œê·¸ì¸ ì „ì—ëŠ” ë¦¬ìŠ¤ë„ˆê°€ ë“±ë¡ë˜ì§€ ì•ŠìŒ
2. ì•±ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ì–´ë„ `initialize()`ê°€ í˜¸ì¶œë˜ê¸° ì „ì—ëŠ” ì‘ë™ ì•ˆ í•¨
3. íƒ€ì´ë° ì´ìŠˆë¡œ ì´ë²¤íŠ¸ë¥¼ ë†“ì¹  ìˆ˜ ìˆìŒ

## í•´ê²° ë°©ë²•

### 1. main.dartë¡œ ë¦¬ìŠ¤ë„ˆ ì´ë™

**íŒŒì¼**: `lib/main.dart`

```dart
/// ë°±ê·¸ë¼ìš´ë“œâ†’í¬ê·¸ë¼ìš´ë“œ ì•Œë¦¼ íƒ­ í•¸ë“¤ëŸ¬ ì„¤ì •
void _setupBackgroundNotificationHandler(GoRouter router) {
  // ì•±ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì•Œë¦¼ íƒ­ìœ¼ë¡œ í¬ê·¸ë¼ìš´ë“œë¡œ ì „í™˜ëœ ê²½ìš°
  FirebaseMessaging.onMessageOpenedApp.listen((RemoteMessage message) {
    debugPrint('========================================');
    debugPrint('ğŸ“± [ë°±ê·¸ë¼ìš´ë“œâ†’í¬ê·¸ë¼ìš´ë“œ] FCM ì•Œë¦¼ìœ¼ë¡œ ì•± ì—´ë¦¼');
    debugPrint('ë©”ì‹œì§€ ID: ${message.messageId}');
    debugPrint('ì œëª©: ${message.notification?.title}');
    debugPrint('ë‚´ìš©: ${message.notification?.body}');
    debugPrint('ë°ì´í„°: ${message.data}');
    debugPrint('========================================');

    // ì•Œë¦¼ íƒ­ ì²˜ë¦¬ (ë¼ìš°í„°ê°€ ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìŒ)
    FcmService.instance.handleNotificationTap(message);
  });
}
```

**initState()ì—ì„œ í˜¸ì¶œ**:
```dart
@override
void initState() {
  super.initState();
  WidgetsBinding.instance.addPostFrameCallback((_) {
    if (mounted) {
      final router = ref.read(routerProvider);
      // ... ë‹¤ë¥¸ ì´ˆê¸°í™”

      // ë°±ê·¸ë¼ìš´ë“œâ†’í¬ê·¸ë¼ìš´ë“œ ì•Œë¦¼ íƒ­ ì²˜ë¦¬ (ì•± ì‹¤í–‰ ì¤‘)
      _setupBackgroundNotificationHandler(router);
    }
  });
}
```

**ì¥ì **:
- ì•± ì‹œì‘ ì§í›„ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ë¡œê·¸ì¸ ì—¬ë¶€ ë¬´ê´€)
- ë¼ìš°í„°ë„ ì´ë¯¸ ì¤€ë¹„ëœ ìƒíƒœ
- íƒ€ì´ë° ì´ìŠˆ í•´ê²°

### 2. FCMServiceì—ì„œ ì¤‘ë³µ ë¦¬ìŠ¤ë„ˆ ì œê±°

**íŒŒì¼**: `lib/shared/service/fcm_service.dart`

```dart
// í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ
FirebaseMessaging.onMessage.listen((RemoteMessage message) {
  // ... í¬ê·¸ë¼ìš´ë“œ ì•Œë¦¼ ì²˜ë¦¬
});

// ë°±ê·¸ë¼ìš´ë“œâ†’í¬ê·¸ë¼ìš´ë“œ ì•Œë¦¼ íƒ­ ì²˜ë¦¬ëŠ” main.dartì—ì„œ ì²˜ë¦¬
// (ë¡œê·¸ì¸ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì•± ì‹œì‘ ì‹œì ì— ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë˜ì–´ì•¼ í•˜ë¯€ë¡œ)

// í† í° ê°±ì‹  ë¦¬ìŠ¤ë„ˆ
_messaging.onTokenRefresh.listen((newToken) {
  // ... í† í° ê°±ì‹  ì²˜ë¦¬
});
```

**ë³€ê²½ ì‚¬í•­**:
- `onMessageOpenedApp` ë¦¬ìŠ¤ë„ˆ ì œê±°
- ì£¼ì„ìœ¼ë¡œ ì´ìœ  ëª…ì‹œ

### 3. GoRouter import ì¶”ê°€

**íŒŒì¼**: `lib/main.dart`

```dart
import 'package:go_router/go_router.dart';
```

**ì´ìœ **: `_setupBackgroundNotificationHandler(GoRouter router)` ì‹œê·¸ë‹ˆì²˜ì—ì„œ ì‚¬ìš©

## ì‘ë™ íë¦„

### Before (ë¬¸ì œ ë°œìƒ)
```
1. ì•± ë°±ê·¸ë¼ìš´ë“œ ìƒíƒœ
2. ì±„íŒ… ì•Œë¦¼ ìˆ˜ì‹ 
3. ì‚¬ìš©ìê°€ ì•Œë¦¼ íƒ­
4. onMessageOpenedApp ì´ë²¤íŠ¸ ë°œìƒ
5. âŒ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì•ˆ ë¨ (ë¡œê·¸ì¸ ì „)
6. ì•±ë§Œ í¬ê·¸ë¼ìš´ë“œë¡œ ì „í™˜
```

### After (í•´ê²°)
```
1. ì•± ì‹œì‘ (initState)
2. âœ… onMessageOpenedApp ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (main.dart)
3. ì•± ë°±ê·¸ë¼ìš´ë“œ ìƒíƒœ
4. ì±„íŒ… ì•Œë¦¼ ìˆ˜ì‹ 
5. ì‚¬ìš©ìê°€ ì•Œë¦¼ íƒ­
6. onMessageOpenedApp ì´ë²¤íŠ¸ ë°œìƒ
7. âœ… ë¦¬ìŠ¤ë„ˆ í˜¸ì¶œ
8. handleNotificationTap() ì‹¤í–‰
9. âœ… ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™ (/chat/:id?chatRoomId=...)
```

## ì•Œë¦¼ ì²˜ë¦¬ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì•± ì¢…ë£Œ ìƒíƒœì—ì„œ ì•Œë¦¼ íƒ­
- ì²˜ë¦¬: `_handleInitialMessage()` (main.dart)
- ë©”ì„œë“œ: `FirebaseMessaging.getInitialMessage()`
- ì‹œì : ì•± ì‹œì‘ ì§í›„

### ì‹œë‚˜ë¦¬ì˜¤ 2: ë°±ê·¸ë¼ìš´ë“œâ†’í¬ê·¸ë¼ìš´ë“œ ì•Œë¦¼ íƒ­
- ì²˜ë¦¬: `_setupBackgroundNotificationHandler()` (main.dart)
- ë©”ì„œë“œ: `FirebaseMessaging.onMessageOpenedApp`
- ì‹œì : ì•± ì‹¤í–‰ ì¤‘

### ì‹œë‚˜ë¦¬ì˜¤ 3: ì•± ì‹¤í–‰ ì¤‘ ì•Œë¦¼ ìˆ˜ì‹  (í¬ê·¸ë¼ìš´ë“œ)
- ì²˜ë¦¬: `FirebaseMessaging.onMessage` (fcm_service.dart)
- ë©”ì„œë“œ: `_handleMessageReceived()`
- ë™ì‘: ì½œë°± í˜¸ì¶œ (UI ì—…ë°ì´íŠ¸)

## í•µì‹¬ í¬ì¸íŠ¸

1. **ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì‹œì **
   - `onMessageOpenedApp`ì€ ì•± ì‹œì‘ ì§í›„ ë“±ë¡ í•„ìš”
   - ë¡œê·¸ì¸ í›„ ë“±ë¡í•˜ë©´ ì´ë²¤íŠ¸ë¥¼ ë†“ì¹  ìˆ˜ ìˆìŒ

2. **ì¤‘ë³µ ë¦¬ìŠ¤ë„ˆ ë°©ì§€**
   - main.dartì—ì„œ ë“±ë¡í•˜ë¯€ë¡œ FCMServiceì—ì„œ ì œê±°
   - ì—¬ëŸ¬ ë²ˆ ë“±ë¡í•˜ë©´ í•¸ë“¤ëŸ¬ê°€ ì¤‘ë³µ í˜¸ì¶œë¨

3. **ë¼ìš°í„° ì¤€ë¹„ ìƒíƒœ**
   - `addPostFrameCallback`ì—ì„œ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
   - ë¼ìš°í„°ê°€ ì´ë¯¸ ì¤€ë¹„ëœ ìƒíƒœ

4. **ë¡œê·¸ ì¶”ê°€**
   - ë””ë²„ê¹…ì„ ìœ„í•œ ìƒì„¸ ë¡œê·¸
   - ì–´ë–¤ ì‹œë‚˜ë¦¬ì˜¤ì¸ì§€ ëª…í™•íˆ êµ¬ë¶„

## ìˆ˜ì •ëœ ìœ„ì¹˜

### main.dart
- Line 15: `import 'package:go_router/go_router.dart';` ì¶”ê°€
- Line 140: `_setupBackgroundNotificationHandler(router);` í˜¸ì¶œ
- Line 166-180: `_setupBackgroundNotificationHandler()` ë©”ì„œë“œ ì¶”ê°€

### fcm_service.dart
- Line 67-68: ì¤‘ë³µ `onMessageOpenedApp` ë¦¬ìŠ¤ë„ˆ ì œê±° ë° ì£¼ì„ ì¶”ê°€

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ì•± ì¢…ë£Œ ìƒíƒœì—ì„œ ì•Œë¦¼ íƒ­
```
1. ì•± ì™„ì „ ì¢…ë£Œ
2. ì±„íŒ… ì•Œë¦¼ ìˆ˜ì‹ 
3. ì•Œë¦¼ íƒ­
4. ì•± ì‹œì‘ â†’ ì±„íŒ…ë°©ìœ¼ë¡œ ì§ì ‘ ì´ë™
```

**ì˜ˆìƒ ë¡œê·¸**:
```
ğŸ“± [ì•± ì‹œì‘] FCM ì•Œë¦¼ìœ¼ë¡œ ì•± ì‹œì‘ë¨
ë°ì´í„°: {type: chat_message, chatRoomId: 456, productId: 138}
ğŸ”— ì±„íŒ… í™”ë©´ìœ¼ë¡œ ì´ë™: productId=138, chatRoomId=456
âœ… ì±„íŒ… í™”ë©´ìœ¼ë¡œ ì´ë™ ì™„ë£Œ
```

### 2. ë°±ê·¸ë¼ìš´ë“œâ†’í¬ê·¸ë¼ìš´ë“œ ì•Œë¦¼ íƒ­ â­
```
1. ì•± ì‹¤í–‰ ì¤‘ (í™ˆ í™”ë©´)
2. í™ˆ ë²„íŠ¼ìœ¼ë¡œ ë°±ê·¸ë¼ìš´ë“œ ì „í™˜
3. ì±„íŒ… ì•Œë¦¼ ìˆ˜ì‹ 
4. ì•Œë¦¼ íƒ­
5. ì•± í¬ê·¸ë¼ìš´ë“œ ì „í™˜ + ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™
```

**ì˜ˆìƒ ë¡œê·¸**:
```
ğŸ“± [ë°±ê·¸ë¼ìš´ë“œâ†’í¬ê·¸ë¼ìš´ë“œ] FCM ì•Œë¦¼ìœ¼ë¡œ ì•± ì—´ë¦¼
ë©”ì‹œì§€ ID: xxx
ë°ì´í„°: {type: chat_message, chatRoomId: 456, productId: 138}
ğŸ”— ì±„íŒ… í™”ë©´ìœ¼ë¡œ ì´ë™: productId=138, chatRoomId=456
âœ… ì±„íŒ… í™”ë©´ìœ¼ë¡œ ì´ë™ ì™„ë£Œ
```

### 3. ì•± ì‹¤í–‰ ì¤‘ ì•Œë¦¼ ìˆ˜ì‹  (í¬ê·¸ë¼ìš´ë“œ)
```
1. ì•± ì‹¤í–‰ ì¤‘ (í™ˆ í™”ë©´)
2. ì±„íŒ… ì•Œë¦¼ ìˆ˜ì‹ 
3. ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
4. ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì±„íŒ… íƒ­ ì´ë™
```

**ì˜ˆìƒ ë¡œê·¸**:
```
ğŸ“± [í¬ê·¸ë¼ìš´ë“œ] FCM ì•Œë¦¼ ìˆ˜ì‹ 
ë°ì´í„°: {type: chat_message, chatRoomId: 456}
ğŸ“© FCM ì•Œë¦¼ìœ¼ë¡œ ì±„íŒ…ë°© ì •ë³´ ê°±ì‹  íŠ¸ë¦¬ê±°: chatRoomId=456
```

## ê²°ê³¼
âœ… ë°±ê·¸ë¼ìš´ë“œâ†’í¬ê·¸ë¼ìš´ë“œ ì•Œë¦¼ íƒ­ ì‹œ ì±„íŒ…ë°©ìœ¼ë¡œ ì •ìƒ ì´ë™
âœ… ì•± ì¢…ë£Œ ìƒíƒœì—ì„œ ì•Œë¦¼ íƒ­ ì‹œ ì •ìƒ ì‘ë™ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
âœ… ë¡œê·¸ì¸ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì•Œë¦¼ ì²˜ë¦¬ ì •ìƒ ì‘ë™
âœ… ì¤‘ë³µ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¡œ ì•ˆì •ì„± í–¥ìƒ

## ì°¸ê³ 

### Firebase Messaging ì´ë²¤íŠ¸ ì¢…ë¥˜
1. **getInitialMessage()**: ì•± ì¢…ë£Œ â†’ ì•Œë¦¼ íƒ­ â†’ ì•± ì‹œì‘
2. **onMessageOpenedApp**: ë°±ê·¸ë¼ìš´ë“œ â†’ ì•Œë¦¼ íƒ­ â†’ í¬ê·¸ë¼ìš´ë“œ
3. **onMessage**: ì•± ì‹¤í–‰ ì¤‘ ì•Œë¦¼ ìˆ˜ì‹  (í¬ê·¸ë¼ìš´ë“œ)
4. **onBackgroundMessage**: ë°±ê·¸ë¼ìš´ë“œ ì•Œë¦¼ ìˆ˜ì‹  (top-level í•¨ìˆ˜)

### ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì‹œì 
- `getInitialMessage()`: ì•± ì‹œì‘ í›„ ì–¸ì œë“ ì§€ í˜¸ì¶œ ê°€ëŠ¥
- `onMessageOpenedApp`: ì•± ì‹œì‘ ì§í›„ ë“±ë¡ í•„ìš” (ì´ë²¤íŠ¸ ë†“ì¹  ìˆ˜ ìˆìŒ)
- `onMessage`: ë¡œê·¸ì¸ í›„ ë“±ë¡ ê°€ëŠ¥ (í¬ê·¸ë¼ìš´ë“œë§Œ í•´ë‹¹)
- `onBackgroundMessage`: `main()`ì—ì„œ ë“±ë¡ (ì•± ì´ˆê¸°í™” ì „)
